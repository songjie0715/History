"undefined"!=typeof KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.jws&&KJUR.jws||(KJUR.jws={}),KJUR.jws.JWS=function(){var t=KJUR.jws.JWS;this.parseJWS=function(e,r){if(void 0===this.parsedJWS||!r&&void 0===this.parsedJWS.sigvalH){var i=e.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==i)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var n=i[1],a=i[2],o=i[3],s=n+"."+a;if(this.parsedJWS={},this.parsedJWS.headB64U=n,this.parsedJWS.payloadB64U=a,this.parsedJWS.sigvalB64U=o,this.parsedJWS.si=s,!r){var f=b64utohex(o),u=parseBigInt(f,16);this.parsedJWS.sigvalH=f,this.parsedJWS.sigvalBI=u}var l=b64utoutf8(n),S=b64utoutf8(a);if(this.parsedJWS.headS=l,this.parsedJWS.payloadS=S,!t.isSafeJSONString(l,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+l}}},KJUR.jws.JWS.sign=function(t,e,r,i,n){var a,o,s,f=KJUR.jws.JWS;if("string"!=typeof e&&"object"!=typeof e)throw"spHeader must be JSON string or object: "+e;if("object"==typeof e&&(o=e,a=JSON.stringify(o)),"string"==typeof e){if(a=e,!f.isSafeJSONString(a))throw"JWS Head is not safe JSON string: "+a;o=f.readSafeJSONString(a)}if(s=r,"object"==typeof r&&(s=JSON.stringify(r)),""!=t&&null!=t||void 0===o.alg||(t=o.alg),""!=t&&null!=t&&void 0===o.alg&&(o.alg=t,a=JSON.stringify(o)),t!==o.alg)throw"alg and sHeader.alg doesn't match: "+t+"!="+o.alg;var u=null;if(void 0===f.jwsalg2sigalg[t])throw"unsupported alg name: "+t;u=f.jwsalg2sigalg[t];var l=utf8tob64u(a),S=utf8tob64u(s),g=l+"."+S,d="";if("Hmac"==u.substr(0,4)){if(void 0===i)throw"mac key shall be specified for HS* alg";var y=new KJUR.crypto.Mac({alg:u,prov:"cryptojs",pass:i});y.updateString(g),d=y.doFinal()}else if(u.indexOf("withECDSA")!=-1){var p=new KJUR.crypto.Signature({alg:u});p.init(i,n),p.updateString(g),hASN1Sig=p.sign(),d=KJUR.crypto.ECDSA.asn1SigToConcatSig(hASN1Sig)}else if("none"!=u){var p=new KJUR.crypto.Signature({alg:u});p.init(i,n),p.updateString(g),d=p.sign()}var J=hextob64u(d);return g+"."+J},KJUR.jws.JWS.verify=function(t,e,r){var i=KJUR.jws.JWS,n=t.split("."),a=n[0],o=n[1],s=a+"."+o,f=b64utohex(n[2]),u=i.readSafeJSONString(b64utoutf8(n[0])),l=null,S=null;if(void 0===u.alg)throw"algorithm not specified in header";if(l=u.alg,S=l.substr(0,2),null!=r&&"[object Array]"===Object.prototype.toString.call(r)&&r.length>0){var g=":"+r.join(":")+":";if(g.indexOf(":"+l+":")==-1)throw"algorithm '"+l+"' not accepted in the list"}if("none"!=l&&null===e)throw"key shall be specified to verify.";if("string"==typeof e&&e.indexOf("-----BEGIN ")!=-1&&(e=KEYUTIL.getKey(e)),!("RS"!=S&&"PS"!=S||e instanceof RSAKey))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==S&&!(e instanceof KJUR.crypto.ECDSA))throw"key shall be a ECDSA obj for ES* algs";var d=null;if(void 0===i.jwsalg2sigalg[u.alg])throw"unsupported alg name: "+l;if(d=i.jwsalg2sigalg[l],"none"==d)throw"not supported";if("Hmac"==d.substr(0,4)){var y=null;if(void 0===e)throw"hexadecimal key shall be specified for HMAC";var p=new KJUR.crypto.Mac({alg:d,pass:e});return p.updateString(s),y=p.doFinal(),f==y}if(d.indexOf("withECDSA")!=-1){var J=null;try{J=KJUR.crypto.ECDSA.concatSigToASN1Sig(f)}catch(c){return!1}var h=new KJUR.crypto.Signature({alg:d});return h.init(e),h.updateString(s),h.verify(J)}var h=new KJUR.crypto.Signature({alg:d});return h.init(e),h.updateString(s),h.verify(f)},KJUR.jws.JWS.parse=function(t){var e,r,i,n=t.split("."),a={};if(2!=n.length&&3!=n.length)throw"malformed sJWS: wrong number of '.' splitted elements";return e=n[0],r=n[1],3==n.length&&(i=n[2]),a.headerObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(e)),a.payloadObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(r)),a.headerPP=JSON.stringify(a.headerObj,null,"  "),null==a.payloadObj?a.payloadPP=b64utoutf8(r):a.payloadPP=JSON.stringify(a.payloadObj,null,"  "),void 0!==i&&(a.sigHex=b64utohex(i)),a},KJUR.jws.JWS.verifyJWT=function(t,e,r){var i=KJUR.jws.JWS,n=t.split("."),a=n[0],o=n[1],s=(b64utohex(n[2]),i.readSafeJSONString(b64utoutf8(a))),f=i.readSafeJSONString(b64utoutf8(o));if(void 0===s.alg)return!1;if(void 0===r.alg)throw"acceptField.alg shall be specified";if(!i.inArray(s.alg,r.alg))return!1;if(void 0!==f.iss&&"object"==typeof r.iss&&!i.inArray(f.iss,r.iss))return!1;if(void 0!==f.sub&&"object"==typeof r.sub&&!i.inArray(f.sub,r.sub))return!1;if(void 0!==f.aud&&"object"==typeof r.aud)if("string"==typeof f.aud){if(!i.inArray(f.aud,r.aud))return!1}else if("object"==typeof f.aud&&!i.includedArray(f.aud,r.aud))return!1;var u=KJUR.jws.IntDate.getNow();return void 0!==r.verifyAt&&"number"==typeof r.verifyAt&&(u=r.verifyAt),void 0!==r.gracePeriod&&"number"==typeof r.gracePeriod||(r.gracePeriod=0),!(void 0!==f.exp&&"number"==typeof f.exp&&f.exp+r.gracePeriod<u)&&(!(void 0!==f.nbf&&"number"==typeof f.nbf&&u<f.nbf-r.gracePeriod)&&(!(void 0!==f.iat&&"number"==typeof f.iat&&u<f.iat-r.gracePeriod)&&((void 0===f.jti||void 0===r.jti||f.jti===r.jti)&&!!KJUR.jws.JWS.verify(t,e,r.alg))))},KJUR.jws.JWS.includedArray=function(t,e){var r=KJUR.jws.JWS.inArray;if(null===t)return!1;if("object"!=typeof t)return!1;if("number"!=typeof t.length)return!1;for(var i=0;i<t.length;i++)if(!r(t[i],e))return!1;return!0},KJUR.jws.JWS.inArray=function(t,e){if(null===e)return!1;if("object"!=typeof e)return!1;if("number"!=typeof e.length)return!1;for(var r=0;r<e.length;r++)if(e[r]==t)return!0;return!1},KJUR.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},KJUR.jws.JWS.isSafeJSONString=function(t,e,r){var i=null;try{return i=jsonParse(t),"object"!=typeof i?0:i.constructor===Array?0:(e&&(e[r]=i),1)}catch(n){return 0}},KJUR.jws.JWS.readSafeJSONString=function(t){var e=null;try{return e=jsonParse(t),"object"!=typeof e?null:e.constructor===Array?null:e}catch(r){return null}},KJUR.jws.JWS.getEncodedSignatureValueFromJWS=function(t){var e=t.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==e)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return e[1]},KJUR.jws.JWS.getJWKthumbprint=function(t){if("RSA"!==t.kty&&"EC"!==t.kty&&"oct"!==t.kty)throw"unsupported algorithm for JWK Thumprint";var e="{";if("RSA"===t.kty){if("string"!=typeof t.n||"string"!=typeof t.e)throw"wrong n and e value for RSA key";e+='"e":"'+t.e+'",',e+='"kty":"'+t.kty+'",',e+='"n":"'+t.n+'"}'}else if("EC"===t.kty){if("string"!=typeof t.crv||"string"!=typeof t.x||"string"!=typeof t.y)throw"wrong crv, x and y value for EC key";e+='"crv":"'+t.crv+'",',e+='"kty":"'+t.kty+'",',e+='"x":"'+t.x+'",',e+='"y":"'+t.y+'"}'}else if("oct"===t.kty){if("string"!=typeof t.k)throw"wrong k value for oct(symmetric) key";e+='"kty":"'+t.kty+'",',e+='"k":"'+t.k+'"}'}var r=rstrtohex(e),i=KJUR.crypto.Util.hashHex(r,"sha256"),n=hextob64u(i);return n},KJUR.jws.IntDate={},KJUR.jws.IntDate.get=function(t){if("now"==t)return KJUR.jws.IntDate.getNow();if("now + 1hour"==t)return KJUR.jws.IntDate.getNow()+3600;if("now + 1day"==t)return KJUR.jws.IntDate.getNow()+86400;if("now + 1month"==t)return KJUR.jws.IntDate.getNow()+2592e3;if("now + 1year"==t)return KJUR.jws.IntDate.getNow()+31536e3;if(t.match(/Z$/))return KJUR.jws.IntDate.getZulu(t);if(t.match(/^[0-9]+$/))return parseInt(t);throw"unsupported format: "+t},KJUR.jws.IntDate.getZulu=function(t){var e=t.match(/(\d+)(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)Z/);if(e){var r=e[1],i=parseInt(r);if(4==r.length);else{if(2!=r.length)throw"malformed year string";if(50<=i&&i<100)i=1900+i;else{if(!(0<=i&&i<50))throw"malformed year string for UTCTime";i=2e3+i}}var n=parseInt(e[2])-1,a=parseInt(e[3]),o=parseInt(e[4]),s=parseInt(e[5]),f=parseInt(e[6]),u=new Date(Date.UTC(i,n,a,o,s,f));return~~(u/1e3)}throw"unsupported format: "+t},KJUR.jws.IntDate.getNow=function(){var t=~~(new Date/1e3);return t},KJUR.jws.IntDate.intDate2UTCString=function(t){var e=new Date(1e3*t);return e.toUTCString()},KJUR.jws.IntDate.intDate2Zulu=function(t){var e=new Date(1e3*t),r=("0000"+e.getUTCFullYear()).slice(-4),i=("00"+(e.getUTCMonth()+1)).slice(-2),n=("00"+e.getUTCDate()).slice(-2),a=("00"+e.getUTCHours()).slice(-2),o=("00"+e.getUTCMinutes()).slice(-2),s=("00"+e.getUTCSeconds()).slice(-2);return r+i+n+a+o+s+"Z"};