{"version":3,"sources":["wx/components/purchaseDialog.js"],"names":["define","$","Dialog","BookDetailService","loading","overlay","resultTipDialog","core","purchaseDialog","template","data","selectedIndex","selectedChapters","btnList","text","discount","active","costPrice","discountPrice","isActive","balancePrice","buyVoid","isGetPrice","unBuyCount","buyText","buyFlag","computed","this","events","show","self","undefined","getDiscount","currentChapter","then","status","obj","result","balances","each","i","v","j","$emit","location","href","url","alert","changeBuyText","methods","hideDialog","hide","purchase","num","chapterId","isZindex","purchaseChapter","isAutoSub","wap_DOMAIN","setContent","setTimeout","reload","select","index","isCheck","isVoid","autoSub"],"mappings":"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","file":"../../../wx/components/purchaseDialog.js","sourcesContent":["/**\n * Created by janey on 16/6/20.\n */\n\ndefine([\n'jquery',\n'components/dialog',\n'service/bookDetailService',\n'components/loading',\n'components/overlay',\n'components/resultTipDialog',\n'core'\n], function($,Dialog, BookDetailService, loading, overlay, resultTipDialog,core){\n\n    var purchaseDialog = new Dialog({\n        template: '#template-buy-dialog',\n        data: {\n            selectedIndex: 0,\n            selectedChapters: 20,\n            btnList: [{\n                text: '后20章',\n                discount: '九折',\n                active: false,\n                costPrice: 0,\n                discountPrice: 0\n            },{\n                text: '后50章',\n                discount: '八折',\n                active: false,\n                costPrice: 0,\n                discountPrice: 0\n            },{\n                text: '后100章',\n                discount: '七折',\n                active: false,\n                costPrice: 0,\n                discountPrice: 0\n            },{\n                text: '后200章',\n                discount: '六折',\n                active: false,\n                costPrice: 0,\n                discountPrice: 0\n            }],\n            isActive: false,\n            balancePrice: '',\n            costPrice: 0,\n            discountPrice: 0,\n            buyVoid: true,\n            isGetPrice: false,\n            unBuyCount: 0,\n            buyText: '确认购买',\n            buyFlag: false\n        },\n        computed: {\n            buyVoid: function(){\n                if( this.balancePrice &&  this.balancePrice != 0 && this.balancePrice >= this.discountPrice && this.unBuyCount >= this.selectedChapters ){\n                    return false;\n                } else {\n                    return true;\n                }\n            }\n        },\n        events: {\n            show: function(){\n                var self = this;\n                if ( this.buyFlag ) return;\n                this.buyFlag = true;\n                if( this.balancePrice != undefined && this.balancePrice !== '' ) return;\n                BookDetailService.getDiscount(self.currentChapter).then(function(data){\n                    switch ( data.status ){\n                        case 0:\n                            var obj = data.result.discount;\n                            self.isGetPrice = true;\n                            self.balancePrice = data.result.balances;\n                            $.each(obj, function(i,v){\n                                self.btnList[i].costPrice = v[0];\n                                self.btnList[i].discountPrice = v[1];\n                            });\n\n                            var j = self.selectedIndex;\n\n                            self.costPrice = self.btnList[j].costPrice;\n                            self.discountPrice = self.btnList[j].discountPrice;\n                            self.unBuyCount = data.result.unBuyCount;\n\n\n                            self.$emit('changeBuyText');\n                            self.buyFlag = false;\n                            break;\n                        case 1:\n                            location.href = data.url;\n                            break;\n                        case -1:\n                            alert('啊哦,出错了');\n                            break;\n                        default:\n                            alert('啊哦,出错了');\n                    }\n                });\n            },\n            changeBuyText: function(){\n                if( this.balancePrice < this.discountPrice ){\n                    this.buyText = '余额不足';\n                    return;\n                }\n\n                if( this.unBuyCount < this.selectedChapters ){\n                    this.buyText = '剩余章节不足';\n                } else {\n                    this.buyText = '确认购买'\n                }\n            }\n        },\n        methods: {\n            hideDialog: function(){\n                this.hide();\n            },\n            purchase: function(num){\n                var self = this;\n                var chapterId = this.currentChapter;\n                loading.show();\n                overlay.isZindex = true;\n\n                BookDetailService.purchaseChapter(num, chapterId, self.isAutoSub).then(function(data){\n                    loading.hide();\n                    self.hideDialog();\n                    overlay.isZindex = false;\n                    // resultTipDialog.show();\n\n                    switch (data.status){\n                        case 1:\n                            location.href = core.wap_DOMAIN + data.url;\n                        break;\n                        case -1:\n                            resultTipDialog.show();\n                            resultTipDialog.setContent(\"抱歉,购买失败,请重新购买!\", false);\n                            setTimeout(function(){\n                                location.reload();\n                            }, 1000);\n                        break;\n                        default:\n                            alert('啊哦,出错了');\n                    }\n\n\n                });\n            },\n            select: function(index){\n                this.selectedIndex = index;\n\n                switch (index){\n                    case 0:\n                        this.selectedChapters = 20;\n                        break;\n                    case 1:\n                        this.selectedChapters = 50;\n                        break;\n                    case 2:\n                        this.selectedChapters = 100;\n                        break;\n                    case 3:\n                        this.selectedChapters = 200;\n                        break;\n                    default:\n                        this.selectedChapters = 20;\n                }\n\n                this.costPrice = this.btnList[index].costPrice;\n                this.discountPrice = this.btnList[index].discountPrice;\n\n\n                this.$emit('changeBuyText');\n\n            },\n            isCheck: function(index){\n                return index == this.selectedIndex;\n            },\n            isVoid: function(index){\n\n            }\n        }\n    });\n    return function(chapterId, autoSub){\n        purchaseDialog.currentChapter = chapterId;\n        purchaseDialog.autoSub = autoSub || false;\n        return purchaseDialog;\n    };\n});"]}