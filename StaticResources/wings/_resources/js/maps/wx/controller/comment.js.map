{"version":3,"sources":["wx/controller/comment.js"],"names":["define","Vue","commentService","Dialog","loadingMoreMixin","legionConfigVue","resultTipDialog","loading","bookId","isLogIn","haveNextPage","commentDialog","template","data","commentTit","commentDet","commentLen","errorTip","hasContent","isErrorTip","isReply","noTip","contentPLH","isFirst","commentSelf","events","show","hide","computed","this","length","methods","hideDialog","setCommentTit","setComment","review","self","then","status","setContent","setTimeout","reviewVue","isPrivateReview","privateReviewList","unshift","result","location","href","url","alert","blurComment","reset","el","mixins","isTipShow","isLoading","hasNoMore","flag","noLoading","isAjaxLoaded","ajaxReviewItems","likeFlag","scrollBottom","getCommentList","pageNum","concat","reviews","items","init","attached","$","window","on","scrollY","showDialog","getLike","reviewId","e","$this","currentTarget","$likeCount","find","$dataTypeLike","hasClass","likeService","removeClass","addClass","doLike","html","likeCount"],"mappings":"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","file":"../../../wx/controller/comment.js","sourcesContent":["/**\n * Created by janey on 16/6/7.\n */\n\n\ndefine([\n'vue',\n'service/commentService',\n'components/dialog',\n'mixin/loadingMoreMixin',\n'components/legionConfig',\n'components/resultTipDialog',\n'components/loading'\n], function(Vue, commentService,Dialog, loadingMoreMixin, legionConfigVue, resultTipDialog, loading){\n\n    return function(bookId, isLogIn, haveNextPage){\n\n        var commentDialog = new Dialog({\n            template: '#template-comment-dialog',\n            data: {\n                commentTit: '',\n                commentDet: '',\n                commentLen: 0,\n                errorTip: '',\n                hasContent: false,\n                isErrorTip: false,\n                isReply: false,\n                noTip: 'true',\n                contentPLH: '输入评论详情',\n                isFirst: true,\n                commentSelf: '评论'\n            },\n            events:{\n                show: function(){\n\n                },\n                hide: function(){\n                }\n            },\n            computed: {\n                commentLen: function(){\n                    return this.commentDet.length;\n                }\n            },\n            methods: {\n                hideDialog: function(){\n                    this.hide();\n                },\n                setCommentTit: function(){\n                    if( this.commentTit.length != 0 ){\n                        this.isErrorTip = false;\n                    }\n                },\n                setComment: function(){\n                    if( this.commentDet.length != 0 ){\n                        this.isErrorTip = false;\n                    }\n                    this.hasContent = true;\n                },\n                review: function(){\n                    var self = this;\n                    if( this.commentTit.length == 0 ){\n                        this.isErrorTip = true;\n                        this.errorTip = '请输入评论标题';\n                        return;\n                    }\n                    if( this.commentDet.length == 0 ){\n                        this.isErrorTip = true;\n                        this.errorTip = '请输入评论详情';\n                        return;\n                    }\n                    loading.show();\n                    commentService.review(bookId, self.commentTit, self.commentDet).then(function(data){\n                        switch (data.status){\n                            case 0:\n                                self.commentTit = '';\n                                self.commentDet = '';\n                                self.hideDialog();\n                                loading.hide();\n                                resultTipDialog.show();\n                                resultTipDialog.setContent('评论成功', true);\n                                setTimeout(function(){\n                                    resultTipDialog.hide();\n                                    reviewVue.isPrivateReview = true;\n                                },2000);\n                                reviewVue.privateReviewList.unshift(data.result.review);\n                                break;\n                            case 1:\n                                location.href = data.url;\n                            break;\n                            case -1:\n                            break;\n                            default:\n                                alert('啊哦,出错咯');\n                        }\n                    });\n                },\n                blurComment: function(){\n                    if( this.commentDet.length == 0 ){\n                        this.hasContent = false;\n                    }\n                },\n                reset: function(){\n                    this.commentTit = '';\n                    this.commentDet = '';\n                }\n            }\n        });\n\n        var reviewVue = new legionConfigVue({\n            el: '#app',\n            mixins: [loadingMoreMixin],\n            data : {\n                isTipShow: false,\n                isLoading: false,\n                hasNoMore: false,\n                flag: false,\n                noLoading: haveNextPage || false,\n                isAjaxLoaded: false,\n                ajaxReviewItems: [],\n                isPrivateReview: false,\n                privateReviewList: [],\n                likeFlag: false\n            },\n            events: {\n                scrollBottom : function(){\n                    var self = this;\n                    if(this.noLoading){\n                        this.hasNoMore = true;\n                        return;\n                    }\n                    this.isLoading = true;\n                    if(this.flag) return;\n                    this.flag = true;\n                    commentService.getCommentList(bookId, ++self.pageNum).then(function(data){\n\n                        if( data.status == 1 ){\n                            location.href = data.url;\n                        } else if( data.status == 0 ){\n                            self.isAjaxLoaded = true;\n                            self.isLoading = false;\n                            self.flag = false;\n                            self.ajaxReviewItems = self.ajaxReviewItems.concat(data.result.reviews.items);\n                        } else if( data.status == -1 ){\n                            self.isLoading = false;\n                            self.hasNoMore = true;\n                            self.flag = false;\n                        }\n\n                        if( !data.result.reviews.haveNextPage ){\n                            self.noLoading = true;\n                        }\n                    });\n                }\n            },\n            init: function(){\n                this.pageNum = 1;\n            },\n            attached:function(){\n                var self = this;\n                $(window).on('scroll', function(){\n                    // 如果 scrollY == 100, 评论浮窗显示\n                    if( window.scrollY >= 300){\n                        self.isTipShow = true;\n                    } else {\n                        self.isTipShow = false;\n                    }\n                })\n            },\n            methods: {\n                showDialog: function(){\n                    if( !isLogIn ){\n                        location.href = '/accounts/login?backUrl=/review/'+ bookId +'/list';\n                        return;\n                    }\n                    commentDialog.show();\n                },\n                getLike: function(reviewId,e){\n                    if( this.likeFlag) return;\n                    var self = this;\n                    var $this = $(e.currentTarget);\n                    var $likeCount = $this.find('.likeCount');\n                    var $dataTypeLike = $this.hasClass('do');\n                    this.likeFlag = true;\n                    if($dataTypeLike) return;\n                    commentService.likeService(bookId, reviewId).then(function(data){\n                        switch (data.status){\n                            case 0:\n                                if( !$dataTypeLike ){\n                                    $this.addClass('do');\n                                    $this.data('like', !$dataTypeLike);\n                                } else {\n                                    $this.removeClass('do');\n                                    $this.data('like', !$dataTypeLike);\n                                }\n                                self.doLike = true;\n                                $likeCount.html(data.result.likeCount);\n\n                                break;\n                            case 1:\n                                location.href = data.url;\n                                break;\n                            case -1:\n                                alert('啊哦,出错了哦');\n                                break;\n                            default:\n                                alert('啊哦,出错了哦');\n                        }\n                        self.likeFlag = false;\n                    });\n                }\n            }\n        })\n    }\n});"]}