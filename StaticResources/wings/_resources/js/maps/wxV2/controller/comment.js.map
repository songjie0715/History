{"version":3,"sources":["wxV2/controller/comment.js"],"names":["define","Vue","commentService","Dialog","loadingMoreMixin","legionConfigVue","resultTipDialog","loading","bookId","isLogIn","haveNextPage","commentDialog","template","data","commentTit","commentDet","commentLen","errorTip","hasContent","isErrorTip","isReply","noTip","contentPLH","isFirst","commentSelf","events","show","hide","computed","this","length","methods","hideDialog","setCommentTit","setComment","$","trim","review","self","then","status","setContent","setTimeout","reviewVue","isPrivateReview","privateReviewList","unshift","result","location","href","url","alert","blurComment","reset","el","mixins","isTipShow","isLoading","hasNoMore","flag","noLoading","isAjaxLoaded","ajaxReviewItems","likeFlag","scrollBottom","getCommentList","pageNum","concat","reviews","items","init","attached","window","on","scrollY","showDialog","getLike","reviewId","e","$this","currentTarget","$likeCount","find","$dataTypeLike","hasClass","likeService","removeClass","addClass","doLike","html","likeCount"],"mappings":"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","file":"../../../wxV2/controller/comment.js","sourcesContent":["/**\n * Created by janey on 16/6/7.\n */\n\n\ndefine([\n'vue',\n'service/commentService',\n'components/dialog',\n'mixin/loadingMoreMixin',\n'components/legionConfig',\n'components/resultTipDialog',\n'components/loading'\n], function(Vue, commentService,Dialog, loadingMoreMixin, legionConfigVue, resultTipDialog, loading){\n\n    return function(bookId, isLogIn, haveNextPage){\n\n        var commentDialog = new Dialog({\n            template: '#template-comment-dialog',\n            data: {\n                commentTit: '',\n                commentDet: '',\n                commentLen: 0,\n                errorTip: '评论内容最少5个字',\n                hasContent: false,\n                isErrorTip: false,\n                isReply: false,\n                noTip: 'true',\n                contentPLH: '输入评论详情',\n                isFirst: true,\n                commentSelf: '评论'\n            },\n            events:{\n                show: function(){\n\n                },\n                hide: function(){\n                }\n            },\n            computed: {\n                commentLen: function(){\n                    return this.commentDet.length;\n                }\n            },\n            methods: {\n                hideDialog: function(){\n                    this.hide();\n                    this.errorTip = '评论内容最少5个字';\n                },\n                setCommentTit: function(){\n                    if( this.commentTit.length != 0 ){\n                        this.isErrorTip = false;\n                    }\n                },\n                setComment: function(){\n                    if( this.commentDet.length != 0){\n                        this.isErrorTip = false;\n                    }\n                    if(this.commentDet.length > 4){\n                        this.isErrorTip = true;\n                    }else if($.trim(this.commentDet) == ''){\n                        this.isErrorTip = false;\n                    }\n                    this.hasContent = true;\n                },\n                review: function(){\n                    var self = this;\n                    // if( this.commentTit.length == 0 ){\n                    //     this.isErrorTip = true;\n                    //     this.errorTip = '请输入评论标题';\n                    //     return;\n                    // }\n                    \n                    if( this.commentDet.length == 0){\n                        this.isErrorTip = false;\n                        this.errorTip = '请输入评论详情';\n                        return;\n                    }else if(this.commentDet.length < 5){\n                        this.isErrorTip = false;\n                        this.errorTip = '评论内容最少5个字';\n                        return;\n                    }else if($.trim(this.commentDet) == ''){\n                        this.isErrorTip = false;\n                        this.errorTip = '评论内容不能是空格';\n                        this.commentDet = '';\n                        return;\n                    }else{\n                        this.isErrorTip = true;\n                    }\n                    loading.show();\n                    commentService.review(bookId, self.commentTit, self.commentDet).then(function(data){\n                        switch (data.status){\n                            case 0:\n                                self.commentTit = '';\n                                self.commentDet = '';\n                                self.hideDialog();\n                                loading.hide();\n                                resultTipDialog.show();\n                                resultTipDialog.setContent('评论成功', true);\n                                setTimeout(function(){\n                                    resultTipDialog.hide();\n                                    reviewVue.isPrivateReview = true;\n                                },2000);\n                                reviewVue.privateReviewList.unshift(data.result.review);\n                                self.isErrorTip = false;\n                                break;\n                            case 1:\n                                location.href = data.url;\n                            break;\n                            case -1:\n                            break;\n                            default:\n                                alert('啊哦,出错咯');\n                        }\n                    });\n                },\n                blurComment: function(){\n                    if( this.commentDet.length == 0){\n                        this.hasContent = false;\n                    }\n                },\n                reset: function(){\n                    this.commentTit = '';\n                    this.commentDet = '';\n                }\n            }\n        });\n\n        var reviewVue = new legionConfigVue({\n            el: '#app',\n            mixins: [loadingMoreMixin],\n            data : {\n                isTipShow: false,\n                isLoading: false,\n                hasNoMore: false,\n                flag: false,\n                noLoading: haveNextPage || false,\n                isAjaxLoaded: false,\n                ajaxReviewItems: [],\n                isPrivateReview: false,\n                privateReviewList: [],\n                likeFlag: false\n            },\n            events: {\n                scrollBottom : function(){\n                    var self = this;\n                    if(this.noLoading){\n                        this.hasNoMore = true;\n                        return;\n                    }\n                    this.isLoading = true;\n                    if(this.flag) return;\n                    this.flag = true;\n                    commentService.getCommentList(bookId, ++self.pageNum).then(function(data){\n\n                        if( data.status == 1 ){\n                            location.href = data.url;\n                        } else if( data.status == 0 ){\n                            self.isAjaxLoaded = true;\n                            self.isLoading = false;\n                            self.flag = false;\n                            self.ajaxReviewItems = self.ajaxReviewItems.concat(data.result.reviews.items);\n                        } else if( data.status == -1 ){\n                            self.isLoading = false;\n                            self.hasNoMore = true;\n                            self.flag = false;\n                        }\n\n                        if( !data.result.reviews.haveNextPage ){\n                            self.noLoading = true;\n                        }\n                    });\n                }\n            },\n            init: function(){\n                this.pageNum = 1;\n            },\n            attached:function(){\n                var self = this;\n                $(window).on('scroll', function(){\n                    // 如果 scrollY == 100, 评论浮窗显示\n                    if( window.scrollY >= 300){\n                        self.isTipShow = true;\n                    } else {\n                        self.isTipShow = false;\n                    }\n                })\n            },\n            methods: {\n                showDialog: function(){\n                    if( !isLogIn ){\n                        location.href = '/wx/accounts/login?backUrl=/wx/review/'+ bookId +'/list';\n                        return;\n                    }\n                    commentDialog.show();\n                },\n                getLike: function(reviewId,e){\n                    if( this.likeFlag) return;\n                    var self = this;\n                    var $this = $(e.currentTarget);\n                    var $likeCount = $this.find('.likeCount');\n                    var $dataTypeLike = $this.hasClass('do');\n                    this.likeFlag = true;\n                    if($dataTypeLike) return;\n                    commentService.likeService(bookId, reviewId).then(function(data){\n                        switch (data.status){\n                            case 0:\n                                if( !$dataTypeLike ){\n                                    $this.addClass('do');\n                                    $this.data('like', !$dataTypeLike);\n                                } else {\n                                    $this.removeClass('do');\n                                    $this.data('like', !$dataTypeLike);\n                                }\n                                self.doLike = true;\n                                $likeCount.html(data.result.likeCount);\n\n                                break;\n                            case 1:\n                                location.href = data.url;\n                                break;\n                            case -1:\n                                alert('啊哦,出错了哦');\n                                break;\n                            default:\n                                alert('啊哦,出错了哦');\n                        }\n                        self.likeFlag = false;\n                    });\n                }\n            }\n        })\n    }\n});"]}