{"version":3,"sources":["controller/viewMaterial.js"],"names":["define","Vue","sidebar","Clipboard","list","el","mixins","data","channelList","channelGenerateList","mounted","$","on","$this","this","closest","find","removeClass","addClass","methods","toImage","convertImgToBase64","url","callback","outputFormat","dataURL","img","Image","src","crossOrigin","onload","canvas","document","createElement","ctx","getContext","height","width","drawImage","toDataURL","$wrapperHtml","html","replace","each","i","v","attr","base64Img","setTimeout","w","h","$generateImg","context","fillStyle","scale","html2canvas","querySelector","onrendered","dataUrl","append","modal","toBlob","blob","saveAs","createLink","$channelList","checkeditem","checked","push","length","ajax","type","serialize","async","error","request","alert","success","linkList","j","clipText","clipboard","e","change","item","parentId","parent","d","id","children","filter","forEach"],"mappings":"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","file":"../../controller/viewMaterial.js","sourcesContent":["/**\n * Created by janey on 2017/4/27.\n */\ndefine([\n    'vue',\n    'mixin/sidebar',\n    '../../components/clipboard.min',\n    // '../../components/ckeditor2/ckeditor',\n    '../../components/html2canvas',\n    '../../components/blueimp-canvas-to-blob/js/canvas-to-blob',\n    '../../components/file-saver/FileSaver'\n], function (Vue,sidebar, Clipboard) {\n    return function(list){\n        return new Vue({\n            el: '#app',\n            mixins:[sidebar],\n            data: {\n                channelList: list,\n                channelGenerateList: ''\n            },\n            mounted: function () {\n\n                // var self = this;\n\n                //渠道分组展开\n                $('.group-collapse')\n                    .on('show.bs.collapse', function () {\n                        var $this = $(this);\n                        $this.closest('li').find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');\n                    }).on('hide.bs.collapse', function () {\n                    var $this = $(this);\n                    $this.closest('li').find('.glyphicon').removeClass('glyphicon-minus').addClass('glyphicon-plus');\n                });\n\n\n            },\n            methods: {\n                toImage(){\n\n                    // var html = '<div class=\"textWrapper\">'\n                    //     +'<p class=\"image-align-center\"><img alt=\"\" height=\"389\" src=\"http://ls.motieimg.com/RESOURCE/98/263/825d94b95fdb9993c4e911c1bb4f7555_1\" width=\"500\" /></p>'\n                    //     +'<p></p>'\n                    //     +'<p>一年前我遇见了P友阿恒，后来的事大家应该猜得到，我们找了个地儿进行了‘负距离接触’。</p>'\n                    //     +'</div>';\n                    let $wrapperHtml = $('.textWrapper');\n                    let html = $wrapperHtml.html();\n                    // $wrapperHtml.html('<p>'+ html +'</p>')\n                    html = html.replace(/&lt;/g,'<');\n                    html = html.replace(/&gt;/g,'>');\n                    html = html.replace(/&nbsp;/g,'');\n\n                    // var parser = new DOMParser();\n                    // var doc = parser.parseFromString(html, \"text/xml\");\n                    // var ht = doc.querySelector('.textWrapper').outerHTML;\n                    // $('#hiddenContent').html(ht);\n\n                    //如果内容有图片，则把图片url+@.jpg\n                    let img = $wrapperHtml.find('img');\n                    if(img){\n                        $.each(img, function(i, v){\n\n                            convertImgToBase64($(v).attr('src')+'@.jpg', function (base64Img) {\n                                $(v).attr('src', base64Img);\n                            });\n                        });\n                    }\n\n                    // 转换图片为base64格式 解决跨域问题\n                    function convertImgToBase64(url, callback, outputFormat){\n                        var img = new Image();\n                        var dataURL;\n                        img.src = url;\n                        img.crossOrigin=\"anonymous\";\n                        img.onload = function(){\n                            var canvas = document.createElement('canvas');\n                            var ctx = canvas.getContext('2d');\n                            canvas.height = this.height;\n                            canvas.width = this.width;\n                            ctx.drawImage(this,0,0);\n                            dataURL = canvas.toDataURL(outputFormat || 'image/jpeg');\n                            callback(dataURL);\n                            canvas = null;\n                        };\n                    }\n\n\n\n                    setTimeout(function(){\n                        var w = $(\".textWrapper\").width();\n                        var h = $(\".textWrapper\").height();\n                        var $generateImg = $('#generateImg');\n                        //\n                        // //要将 canvas 的宽高设置成容器宽高的 2 倍\n                        var canvas = document.createElement(\"canvas\");\n                        canvas.width = w * 2;\n                        canvas.height = h * 2;\n\n\n                        var context = canvas.getContext(\"2d\");\n                        context.fillStyle=\"white\";\n                        //然后将画布缩放，将图像放大两倍画到画布上\n                        context.scale(0.5,0.5);\n\n                        html2canvas(document.querySelector(\".textWrapper\"), {\n                            canvas: canvas,\n                            onrendered: function(canvas) {\n                                // $('.viewMaterial').append(canvas);\n                                var dataUrl = canvas.toDataURL('image/png');\n                                $generateImg.find('.modal-body').html('').append('<img src=\"'+ dataUrl +'\" />');\n                                $generateImg.modal('show');\n\n                                if(canvas.toBlob){\n                                    canvas.toBlob(\n                                        function (blob) {\n                                            saveAs(blob, \"image.png\");\n                                        },\n                                        'image/png'\n                                    );\n\n\n                                }\n                            }\n                        });\n                    },10)\n\n                },\n                createLink(){\n                    let $channelList = $('.select-channel').find('input[name=\"channelids\"]');\n                    var checkeditem = [];\n                    $.each($channelList, function(i,v){\n                        if( v.checked ){\n                            checkeditem.push(v);\n                        }\n                    });\n                    if( !checkeditem.length ){\n                        alert('请先选择渠道');\n                        return;\n                    }\n\n\n                    $.ajax({\n                        type: \"POST\",\n                        url:\"/weidulm/channel/addOrder\",\n                        data:$('#linkChannel').serialize(),// 你的formid\n                        async: false,\n                        error: function(request) {\n                            alert(\"Connection error\");\n                        },\n                        success: function(data) {\n                            var linkList = '<table class=\"table table-striped table-bordered material-table\"><tbody>';\n                            $.each(data, function(i,v){\n                                for(var j in v){\n                                    linkList += '<tr><th class=\"tit\">'+ j +'</th><td>'+ v[j] +'</td><td><a href=\"javascript:;\" class=\"copyLink\" data-clipboard-action=\"copy\" data-clipboard-text=\"'+ v[j] +'\">复制</a></td></tr>';\n                                }\n                            });\n                            linkList += '</tbody></table>';\n                            $('.createLinkText').html('').append(linkList);\n                            var clipboard = new Clipboard('.copyLink');\n\n                        }\n                    });\n                },\n                clipText(){\n                    let clipboard = new Clipboard('.btn-clip');\n\n                    clipboard.on('success', function(e) {\n                        // alert('已复制');\n                    });\n\n                    clipboard.on('error', function(e) {\n                        alert('报错了');\n                    });\n                },\n                change(item){\n                    if( item.parentId ){\n                        let parent = this.channelList.find(d => d.id == item.parentId);\n                        parent.checked = parent.children.filter(d => d.checked).length == parent.children.length;\n                    } else {\n                        let parent = item;\n                        parent.children.forEach(d => {\n                            d.checked = parent.checked;\n                        })\n                    }\n                }\n            }\n        })\n    }\n});\n\n\n"]}